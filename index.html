<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهداء فلسطين الأبرار</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 0; text-align: center; }
        header { background-color: #1a2a3a; color: white; padding: 15px 20px; border-bottom: 4px solid #4a90e2; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 999; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.8em; }
        .controls-container { padding: 15px; background-color: #e9ecef; border-bottom: 1px solid #ddd; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .control-btn { background-color: #007bff; color: white; border: none; padding: 10px 20px; font-family: 'Tajawal', sans-serif; font-size: 1em; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .control-btn:hover { transform: translateY(-2px); }
        #clear-cache-btn { background-color: #dc3545; }
        .stats-container { background-color: #f8f9fa; padding: 20px; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 20px; border-bottom: 1px solid #ddd; margin-bottom: 40px; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-icon svg { width: 48px; height: 48px; fill: #343a40; }
        .stat-label { font-size: 1em; color: #555; margin-top: 5px; }
        .stat-count { font-size: 2em; font-weight: 900; color: #1a2a3a; }
        .gallery-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 40px; padding: 20px; max-width: 1300px; margin: 0 auto; min-height: 200px; }
        #loading-message { font-size: 1.2em; color: #555; }
        .scene { width: 100%; height: 420px; perspective: 1000px; }
        .martyr-card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94); cursor: pointer; }
        .scene.active .martyr-card, .scene:hover .martyr-card { transform: rotateY(10deg) scale(1.05); }
        .image-frame { position: absolute; width: 100%; height: 100%; background: linear-gradient(145deg, #e6e6e6, #ffffff); border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2), inset 0 0 15px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; overflow: hidden; }
        .image-container { width: calc(100% - 20px); height: 75%; margin: 10px; position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .martyr-card img { width: 100%; height: 100%; object-fit: cover; display: block; transition: opacity 0.4s ease-in-out; opacity: 0; }
        .martyr-card img.loaded { opacity: 1; }
        .name-container { height: 25%; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0 10px; }
        .martyr-name { font-size: 1.5em; font-weight: 900; color: #1a2a3a; margin: 0; }
        .final-message { font-size: 1.1em; color: #d9534f; font-weight: bold; margin-top: 5px; opacity: 0; transition: opacity 0.4s ease 0.2s; }
        .scene.active .final-message, .scene:hover .final-message { opacity: 1; }
        footer { margin-top: 40px; padding: 20px; background-color: #1a2a3a; color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.5s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content { background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); position: relative; width: 90%; max-width: 500px; text-align: center; }
        .modal-content img { max-width: 100%; height: auto; max-height: 60vh; border-radius: 10px; margin-bottom: 20px; border: 2px solid #ddd; object-fit: contain; }
        .modal-content h2 { font-size: 2em; color: #1a2a3a; margin: 10px 0; }
        .modal-content p { font-size: 1.2em; color: #d9534f; font-weight: bold; }
        .close-modal { position: absolute; top: 10px; left: 20px; font-size: 3em; color: #aaa; cursor: pointer; }
        #notification-bell { position: relative; cursor: pointer; }
        #notification-bell svg { width: 32px; height: 32px; fill: #fff; }
        #notification-badge { position: absolute; top: -5px; right: -8px; background-color: #d9534f; color: white; width: 22px; height: 22px; border-radius: 50%; font-size: 0.9em; font-weight: bold; display: none; justify-content: center; align-items: center; border: 2px solid #1a2a3a; }
        #notification-modal .modal-content ul { list-style: none; padding: 0; text-align: right; max-height: 60vh; overflow-y: auto;}
        #notification-modal .notification-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; gap: 15px;}
        #notification-modal .sender-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #333, #555); color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); z-index: 2000; transition: all 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55); border-top: 3px solid #ffc107; font-size: 1.1em; }
        #toast.show { bottom: 30px; }
    </style>
</head>
<body>
    
    <header>
        <h1>شهداء فلسطين الأبرار</h1>
        <div id="notification-bell">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
            <span id="notification-badge"></span>
        </div>
    </header>

    <div class="controls-container">
        <button id="refresh-btn" class="control-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg><span>تحديث البيانات</span></button>
        <button id="clear-cache-btn" class="control-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg><span>مسح كاش المتصفح</span></button>
    </div>

    <section class="stats-container">
        <div class="stat-item"> <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 4a4 4 0 1 0 0 8a4 4 0 0 0 0-8zm0 10c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div> <div class="stat-label">الرجال</div> <div class="stat-count" id="male-count">0</div> </div>
        <div class="stat-item"> <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5.5A3.5 3.5 0 0 0 8.5 9a3.5 3.5 0 0 0 3.5 3.5a3.5 3.5 0 0 0 3.5-3.5A3.5 3.5 0 0 0 12 5.5zm-4 10.5c0-1.67 2.67-2.5 4-2.5s4 .83 4 2.5V18H8v-2z"/></svg></div> <div class="stat-label">النساء</div> <div class="stat-count" id="female-count">0</div> </div>
        <div class="stat-item"> <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C9.24 2 7 4.24 7 7s2.24 5 5 5s5-2.24 5-5S14.76 2 12 2zm0 18c-3.31 0-6-2.69-6-6h12c0 3.31-2.69 6-6 6z"/></svg></div> <div class="stat-label">الأطفال</div> <div class="stat-count" id="child-count">0</div> </div>
        <div class="stat-item"> <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg></div> <div class="stat-label">حجم البيانات</div> <div class="stat-count" id="total-size">0 MB</div> </div>
    </section>

    <main>
        <div id="martyrs-gallery" class="gallery-container">
             <p id="loading-message">يتم الآن تحميل أسماء وصور الشهداء...</p>
        </div>
    </main>

    <footer><p>رحم الله شهداءنا وأسكنهم فسيح جناته</p></footer>

    <div class="modal-overlay" id="image-modal"> <div class="modal-content"> <span class="close-modal">&times;</span> <img id="modal-img" src="" alt="صورة الشهيد"> <h2 id="modal-name"></h2> <p id="modal-message"></p> </div> </div>
    <div class="modal-overlay" id="notification-modal"> <div class="modal-content"> <span class="close-modal">&times;</span> <h2>الإشعارات</h2> <ul id="notification-list"><li>لا توجد إشعارات حالياً.</li></ul> </div> </div>

<script>
    // ===================================================================================
    //  الإصدار 3: الكود الأكثر صلابة وقوة
    //  - يعالج أخطاء جلب البيانات بشكل أفضل: إذا فشل أحد المصادر، يستمر الآخر.
    //  - مصمم للعمل بشكل مثالي عند رفعه على خادم ويب (GitHub Pages).
    // ===================================================================================

    // --- CONFIGURATION ---
    const GITHUB_USERNAME = "hassanoooohcu";
    const GITHUB_REPO = "palestine-martyrs-gallery";
    const RAW_GITHUB_BASE = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/main`;

    const getCacheBuster = () => `?v=${Date.now()}`;
    
    const API_IMAGES_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/images`;
    const DATA_FILE_URL = `${RAW_GITHUB_BASE}/data/martyrs.json`;
    const NO_PHOTO_IMAGE_URL = `${RAW_GITHUB_BASE}/images/nophoto.jpg`;
    
    // --- CORE LOGIC ---

    async function fetchMartyrsData() {
        console.log("Fetching data from both API and JSON file using a resilient method...");
        
        // نستخدم Promise.allSettled الذي لا يفشل بالكامل إذا فشل طلب واحد
        const results = await Promise.allSettled([
            fetch(`${API_IMAGES_URL}${getCacheBuster()}`, { cache: 'no-store' }),
            fetch(`${DATA_FILE_URL}${getCacheBuster()}`, { cache: 'no-store' })
        ]);

        let imageFiles = [];
        let noPhotoMartyrs = [];

        // معالجة نتيجة طلب الصور من API
        if (results[0].status === 'fulfilled' && results[0].value.ok) {
            imageFiles = await results[0].value.json();
            console.log(`Successfully fetched ${imageFiles.length} files from API.`);
        } else {
            console.error("Failed to fetch from GitHub API:", results[0].reason || results[0].value.statusText);
        }

        // معالجة نتيجة طلب ملف JSON
        if (results[1].status === 'fulfilled' && results[1].value.ok) {
            noPhotoMartyrs = await results[1].value.json();
            console.log(`Successfully fetched ${noPhotoMartyrs.length} records from JSON file.`);
        } else {
            console.error("Failed to fetch from JSON file:", results[1].reason || results[1].value.statusText);
        }
        
        if (imageFiles.length === 0 && noPhotoMartyrs.length === 0) {
            throw new Error("Both data sources failed to load.");
        }

        return { imageFiles, noPhotoMartyrs };
    }

    async function main() {
         try {
            document.getElementById('loading-message').style.display = 'block';
            document.getElementById('loading-message').textContent = 'جاري جلب أحدث البيانات...';
            const data = await fetchMartyrsData();
            const allMartyrs = processAndCombineData(data);
            renderGallery(allMartyrs);
        } catch (error) {
            console.error("Main function error:", error);
            document.getElementById('loading-message').textContent = 'فشل تحميل البيانات. الرجاء التأكد من اتصالك بالإنترنت وتحديث الصفحة.';
        }
    }
    
    function processAndCombineData(data) {
        const { imageFiles, noPhotoMartyrs } = data;
        const allMartyrsMap = new Map();
        
        (noPhotoMartyrs || []).forEach(martyr => {
            const normalized = normalizeName(martyr.name);
            if (normalized) {
                allMartyrsMap.set(normalized, { ...martyr, image: NO_PHOTO_IMAGE_URL, size: 0 });
            }
        });
        
        const filteredImageFiles = (imageFiles || []).filter(f => f.type === 'file' && /\.(jpg|jpeg|png|gif|jfif|webp|bmp)$/i.test(f.name));
        filteredImageFiles.forEach(file => {
            const info = parseMartyrInfo(file.name);
            const normalized = normalizeName(info.name);
            if (normalized) {
                allMartyrsMap.set(normalized, { ...info, image: `${RAW_GITHUB_BASE}/images/${file.name}`, size: file.size });
            }
        });
        
        const martyrsArray = Array.from(allMartyrsMap.values());
        // فرز بسيط يعتمد على حجم الملف لوضع أصحاب الصور أولاً
        martyrsArray.sort((a, b) => b.size - a.size); 

        return martyrsArray;
    }

    function renderGallery(martyrs) {
        const galleryContainer = document.getElementById('martyrs-gallery');
        document.getElementById('loading-message').style.display = 'none';
        galleryContainer.innerHTML = '';
        if (!martyrs || martyrs.length === 0) {
            galleryContainer.innerHTML = '<p>لم يتم العثور على شهداء.</p>';
            return;
        }
        
        const fragment = document.createDocumentFragment();
        let counters = { male: 0, female: 0, child: 0 };
        let totalSizeBytes = 0;

        martyrs.forEach(martyr => {
            if(counters.hasOwnProperty(martyr.type)) counters[martyr.type]++;
            totalSizeBytes += martyr.size || 0;
            fragment.appendChild(buildMartyrCard(martyr));
        });

        galleryContainer.appendChild(fragment);
        galleryContainer.querySelectorAll('img[data-src]').forEach(img => imageObserver.observe(img));
        
        document.getElementById('total-size').textContent = formatBytes(totalSizeBytes);
        document.getElementById('male-count').textContent = counters.male;
        document.getElementById('female-count').textContent = counters.female;
        document.getElementById('child-count').textContent = counters.child;
    }

    function buildMartyrCard(martyr) {
        const scene = document.createElement('div');
        scene.className = 'scene';
        let messageText;
        switch (martyr.type) { 
            case 'female': messageText = 'ضحت بحياتها فداءً لوطنها'; break; 
            case 'child': messageText = 'قُدّمت طفولته فداءً لوطنه'; break; 
            default: messageText = 'ضحى بحياته فداءً لوطنه'; break; 
        }
        const imageUrlWithCacheBuster = `${martyr.image}${getCacheBuster()}`;
        scene.innerHTML = `<div class="martyr-card"><div class="image-frame"><div class="image-container"><img data-src="${imageUrlWithCacheBuster}" alt="صورة ${martyr.name}" loading="lazy"></div><div class="name-container"><p class="martyr-name">${martyr.name}</p><p class="final-message">${messageText}</p></div></div></div>`;
        return scene;
    }

    function showToast(message) { document.querySelectorAll('#toast').forEach(t => t.remove()); const toast = document.createElement('div'); toast.id = 'toast'; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => toast.classList.add('show'), 50); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 5000); }
    function formatBytes(bytes, decimals = 2) { if (!bytes || bytes === 0) return '0 Bytes'; const k = 1024; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + ['Bytes', 'KB', 'MB', 'GB'][i]; }
    function parseMartyrInfo(nameString) { let cleanName = decodeURIComponent(nameString).replace(/_/g, ' ').replace(/\.[^/.]+$/, "").trim(); let type = 'male'; if (cleanName.includes('الطفل') || cleanName.includes('الطفلة')) type = 'child'; else if (cleanName.includes('الشهيدة')) type = 'female'; return { name: cleanName, type }; }
    function normalizeName(name) { return name.replace(/^(الشهيد|الشهيدة|الطفل|الطفلة)\s*/, '').replace(/\s+/g, ' ').trim(); }
    let imageObserver; function initImageObserver() { if (imageObserver) imageObserver.disconnect(); imageObserver = new IntersectionObserver((entries, observer) => { entries.forEach(entry => { if (entry.isIntersecting) { const img = entry.target; img.src = img.dataset.src; img.onload = () => img.classList.add('loaded'); observer.unobserve(img); } }); }, { rootMargin: '0px 0px 200px 0px' }); }
    async function performHardReset() { showToast("بدء مسح كاش المتصفح..."); try { if (window.caches) { const keys = await caches.keys(); await Promise.all(keys.map(key => caches.delete(key))); } showToast("تم مسح الكاش بنجاح! سيتم إعادة تحميل الصفحة."); setTimeout(() => window.location.reload(true), 1500); } catch (err) { showToast("⚠️ حدث خطأ. يرجى إعادة تحميل الصفحة يدويًا."); } }
    
    function setupEventListeners() { 
        document.getElementById('refresh-btn').addEventListener('click', () => { showToast("جاري تحديث البيانات وإعادة تحميل الصفحة..."); setTimeout(() => { window.location.reload(true); }, 1500); }); 
        document.getElementById('clear-cache-btn').addEventListener('click', performHardReset); 
        const imageModal = document.getElementById('image-modal'); 
        const galleryContainer = document.getElementById('martyrs-gallery'); 
        galleryContainer.addEventListener('click', (event) => { const clickedScene = event.target.closest('.scene'); if (!clickedScene) return; if (clickedScene.classList.contains('active')) { const img = clickedScene.querySelector('img'); if (img && (img.src || img.dataset.src)) { imageModal.querySelector('#modal-img').src = img.src || img.dataset.src; imageModal.querySelector('#modal-name').textContent = clickedScene.querySelector('.martyr-name').textContent; imageModal.querySelector('#modal-message').textContent = "إِنَّا لِلّهِ وَإِنَّـا إِلَيْهِ رَاجِعونَ"; imageModal.classList.add('active'); } } else { galleryContainer.querySelector('.scene.active')?.classList.remove('active'); clickedScene.classList.add('active'); } }); 
        document.addEventListener('click', (event) => { if (!event.target.closest('.scene')) { document.querySelector('.gallery-container .scene.active')?.classList.remove('active'); } }); 
        document.getElementById('notification-bell').addEventListener('click', () => document.getElementById('notification-modal').classList.add('active')); 
        document.querySelectorAll('.modal-overlay').forEach(overlay => { overlay.addEventListener('click', (e) => { if (e.target === overlay || e.target.classList.contains('close-modal')) { overlay.classList.remove('active'); } }); }); 
    }
    
    document.addEventListener('DOMContentLoaded', () => { 
        initImageObserver(); 
        setupEventListeners(); 
        main(); 
    });
</script>

</body>
</html>
